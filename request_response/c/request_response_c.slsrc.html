<!DOCTYPE html><html><head><title>request_response.c</title>
<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
<script>
  $(function() {
    $( document ).tooltip();
  });
</script>
<style>
#code {background-color:#ffffff;};
</style>
</head>
<body><h1>request_response.c</h1>
<script>hljs.initHighlightingOnLoad();</script>
<small><pre><code id="code"><table border=0 cellpadding=0 cellspacing=0><tr>
<td>00001
00002
<a href="request_response.sldoc.html#includes_ref_1" target="doc">00003</a>
<a href="request_response.sldoc.html#includes_ref_1" target="doc">00004</a>
<a href="request_response.sldoc.html#includes_ref_1" target="doc">00005</a>
<a href="request_response.sldoc.html#includes_ref_1" target="doc">00006</a>
<a href="request_response.sldoc.html#includes_ref_1" target="doc">00007</a>
<a href="request_response.sldoc.html#includes_ref_1" target="doc">00008</a>
<a href="request_response.sldoc.html#includes_ref_1" target="doc">00009</a>
<a href="request_response.sldoc.html#includes_ref_1" target="doc">00010</a>
<a href="request_response.sldoc.html#includes_ref_1" target="doc">00011</a>
<a href="request_response.sldoc.html#includes_ref_1" target="doc">00012</a>
<a href="request_response.sldoc.html#includes_ref_1" target="doc">00013</a>
<a href="request_response.sldoc.html#includes_ref_1" target="doc">00014</a>
<a href="request_response.sldoc.html#includes_ref_1" target="doc">00015</a>
<a href="request_response.sldoc.html#includes_ref_1" target="doc">00016</a>
00017
00018
00019
00020
00021
00022
00023
00024
00025
00026
00027
00028
00029
00030
00031
00032
00033
00034
00035
00036
00037
00038
00039
00040
00041
00042
00043
00044
00045
00046
00047
00048
00049
00050
00051
00052
00053
00054
00055
00056
00057
00058
00059
00060
00061
00062
00063
00064
00065
00066
00067
00068
00069
00070
00071
00072
00073
00074
00075
00076
00077
00078
00079
00080
00081
00082
00083
00084
00085
00086
00087
00088
00089
00090
00091
00092
00093
00094
00095
00096
00097
00098
00099
00100
00101
00102
00103
00104
00105
00106
00107
00108
00109
00110
00111
00112
00113
00114
00115
00116
00117
00118
00119
00120
00121
00122
00123
00124
00125
</td><td>  /* Code Disclaimer? */
  
<span name="includes" id="includes"></span>  #include &lt;stdio.h&gt;
  
  #if defined(_MSC_VER)
  /* Windows-only includes */
  #include &lt;winsock2.h&gt;
  #define SLEEP(s) Sleep((s)*1000)
  #else
  /* Unix-only includes */
  #include &lt;stdlib.h&gt;
  #include &lt;unistd.h&gt;
  #define SLEEP(s) sleep(s)
  #endif
  
  #include &lt;lbm/lbm.h&gt;
  
  /* Example error checking macro.  Include after each UM call. */
  #define EX_LBM_CHK(err) do { \
      if ((err) &lt; 0) { \
              fprintf(stderr, "%s:%d, lbm error: '%s'\n", \
              __FILE__, __LINE__, lbm_errmsg()); \
              exit(1); \
      }  \
  } while (0)
  
  int run = 1;
  
  int rcv_handle_msg(lbm_rcv_t *rcv, lbm_msg_t *msg, void *clientd)
  {
      int err;
  
      switch (msg-&gt;type) {
      case LBM_MSG_REQUEST:
          printf("LBM_MSG_REQUEST received\n");
          err = lbm_send_response(msg-&gt;response, "response", 8, LBM_SRC_NONBLOCK);
          EX_LBM_CHK(err);
          break;
      }
  }
  
  int handle_response(lbm_request_t *req, lbm_msg_t *msg, void *clientd)
  {
          switch (msg-&gt;type) {
          case LBM_MSG_RESPONSE:
          printf("LBM_MSG_RESPONSE received\n");
          run = 0;
          break;
      }
  }
  
  main()
  {
      lbm_context_t *ctx;                     /* Context object */
          lbm_topic_t *stopic;                    /* Source Topic object */
          lbm_src_t *src;                         /* Source object */
          lbm_src_topic_attr_t * tattr;           /* Source topic attribute object */
          lbm_context_attr_t * cattr;             /* Context attribute object */
      lbm_rcv_t *rcv;                 /* Receive object: for subscribing to messages. */
      lbm_topic_t *rtopic;                    /* Receiver Topic object */
      lbm_request_t *req;         /* Request object */
          int err;                                /* Used for checking API return codes */
    
  #if defined(_WIN32)
          /* windows-specific code */
          WSADATA wsadata;
          int wsStat = WSAStartup(MAKEWORD(2,2), &amp;wsadata);
          if (wsStat != 0)
          {
                  printf("line %d: wsStat=%d\n",__LINE__,wsStat);
                  exit(1);
          }
  #endif
    
          err = lbm_context_attr_create(&amp;cattr);
      EX_LBM_CHK(err);
    
          err = lbm_context_create(&amp;ctx, cattr, NULL, NULL);
      EX_LBM_CHK(err);
    
      /* Create receiver for receiving request and sending response */
      err = lbm_rcv_topic_lookup(&amp;rtopic, ctx, "test.topic", NULL);
      EX_LBM_CHK(err);
  
      err = lbm_rcv_create(&amp;rcv, ctx, rtopic, rcv_handle_msg, NULL, NULL);
      EX_LBM_CHK(err);
  
      /* Create source for sending request */
      err = lbm_src_topic_attr_create(&amp;tattr);
      EX_LBM_CHK(err);
    
          err = lbm_src_topic_alloc(&amp;stopic, ctx, "test.topic", tattr);
      EX_LBM_CHK(err);
  
          err = lbm_src_topic_attr_delete(tattr);
      EX_LBM_CHK(err);
  
          err = lbm_src_create(&amp;src, ctx, stopic, NULL, NULL, NULL);
      EX_LBM_CHK(err);
  
      err = lbm_send_request(&amp;req, src, "request", 7, handle_response, NULL, NULL, 0);
      EX_LBM_CHK(err);
  
      while (run) {  /* loop until response received */
              SLEEP(1);
      }
  
      /* Clean up */
      err = lbm_request_delete(req);
      EX_LBM_CHK(err);
  
      err = lbm_src_delete(src);
      EX_LBM_CHK(err);
      
      err = lbm_rcv_delete(rcv);
      EX_LBM_CHK(err);
  
      err = lbm_context_delete(ctx);
      EX_LBM_CHK(err);
  
  #if defined(_MSC_VER)
      /* Windows-specific cleanup overhead */
      WSACleanup();
  #endif
  } /* main */
</td></tr></table></code>




















































































</pre></small></body></html>
